## Коммуникация с роботом

Коммуникация осуществляется либо посредством текстовых сообщений через USB serial port либо BLE UART.
Как именно&nbsp;— определяется полем `ICore.comChannel`.

### Debug-коммуникация через USB serial port

В качестве терминала для отправки и приёма команд можно подойдёт любой tty-терминал,
например `picocom`. Пример команды для подключения к роботу:

```bash
$ picocom -b 115200 --echo /dev/ttyACM0
```

`--echo`&nbsp;— позволяет видеть свой ввод.


### Debug-коммуникация через BLE UART

1. В проекте в codal.json установлены флаги, необходимые для включения BLE.
В будущем ещё хорошо бы `MICROBIT_BLE_DFU_SERVICE` включить.\
Назначение флагов описано [ниже](#ble-flags).

1. (**лишний шаг?**) Pairing робота: на выключенном роботе зажать обе кнопки micro:bit и включить питание.\
После этого устройство будет обнаружено и станет доступным для подключения на других устройствах.

1. Чтобы передавать текстовые команды между micro:bit и ПК через Bluetooth,
используется Nordic UART Service (NUS) поверх BLE.
Этот сервис не отображается как обычный `/dev/ttyUSB*` и требует
предварительного подключения с помощью утилиты `ble-serial`.

Установка `ble-serial`:

```bash
$ pip install ble-serial
```

Удобно устанавливать в виртуальном окружении:

```bash
$ cd <...>
$ python3 -m venv venv
$ source venv/bin/activate
```

```bash
$ ble-serial \
  -d <MAC-address|name> \
  --read-uuid 6e400003-b5a3-f393-e0a9-e50e24dcca9e \
  --write-uuid 6e400002-b5a3-f393-e0a9-e50e24dcca9e
```

Команда:

* инициирует BLE-соединение с micro:bit по его MAC-адресу или имени;

* находит и активирует BLE характеристики UART-сервиса:

* `6e400003-...`&nbsp;— уведомления от micro:bit (TX)

* `6e400002-...`&nbsp;— запись с ПК на micro:bit (RX)

* создаёт виртуальный последовательный порт `/tmp/ttyBLE`,
через который можно работать как с обычным UART.

**Примечание:** `ble-serial` работает нестабильно, может запуститься не с первого раза.

4. После запуска `ble-serial`, можно открывать терминал с помощью `picocom`:

```bash
$ picocom --echo /tmp/ttyBLE
```

`--echo`&nbsp;— позволяет видеть свой ввод.\
`/tmp/ttyBLE`&nbsp;— путь к виртуальному порту, предоставленному `ble-serial`.

## BLE flags
1. `"DEVICE_BLE": 1`\
**Назначение:** Включает драйвер BLE в коде CODAL.\
**Нужен ли:** Обязательно при любой работе с BLE.

1. `"MICROBIT_BLE_ENABLED": 1`\
**Назначение:** Глобальный флаг активации BLE (включает BLE-стек).\
**Нужен ли:** Обязательно для uBit.ble, uBit.bleSerial и т.д.

1. `"MICROBIT_BLE_PAIRING_MODE": 1`\
**Назначение:** Позволяет пользователю инициировать спаривание (pairing) через кнопку при включении.\
**Нужен ли:** Если ты хочешь управлять доступом к BLE (например, шифрование или whitelist)&nbsp;— да.

1. `"MICROBIT_BLE_DFU_SERVICE": 1`\
**Назначение:** Включает Device Firmware Update (DFU) сервис для прошивки по BLE.\
**Нужен ли:** Только если ты планируешь обновлять прошивку по Bluetooth.

1. `"MICROBIT_BLE_DEVICE_INFORMATION_SERVICE": 1`\
**Назначение:** Добавляет BLE-сервис, сообщающий информацию об устройстве (например, manufacturer name, model).\
**Нужен ли:** Необязательно, но полезен для отладки и распознавания устройства через нативные BLE-клиенты.

1. `"MICROBIT_BLE_UTILITY_SERVICE": 1`\
**Назначение:** Служебный BLE-сервис, используемый SDK micro:bit (например, для взаимодействия с mobile app).\
**Нужен ли:** Только если используешь официальное приложение micro:bit или утилиты, зависящие от этого сервиса.

1. `"MICROBIT_BLE_UTILITY_SERVICE_PAIRING": 1`\
**Назначение:** Позволяет выполнять pairing через utility-сервис.\
**Нужен ли:** Только если используешь MICROBIT_BLE_UTILITY_SERVICE.

1. `"MICROBIT_BLE_EVENT_SERVICE": 1`\
**Назначение:** Позволяет получать события MicroBitEvent через BLE.\
**Нужен ли:** Полезно, если ты хочешь отправлять/принимать события между двумя micro:bit или приложением и micro:bit.

1. `"MICROBIT_BLE_PARTIAL_FLASHING": 0`\
**Назначение:** Отключает частичную прошивку (partial flashing), используемую в MakeCode.\
**Нужен ли:** Если ты не используешь MakeCode, можно отключить (как здесь). Это уменьшает размер прошивки.

1. `"MICROBIT_BLE_SECURITY_LEVEL": "SECURITY_MODE_ENCRYPTION_NO_MITM"`\
**Назначение:** Уровень безопасности BLE-соединения.\
**Значения:**\
`"SECURITY_MODE_OPEN"`&nbsp;— без шифрования.\
`"SECURITY_MODE_ENCRYPTION_NO_MITM"`&nbsp;— шифрование без проверки личности (обычное pairing).\
`"SECURITY_MODE_ENCRYPTION_WITH_MITM"`&nbsp;— шифрование + защита от подмены (требуется PIN/кнопка).\
**Нужен ли:** Рекомендуется хотя бы ENCRYPTION_NO_MITM&nbsp;— как в примере.
